<!-- Header with Filter Buttons -->
<div style="background:white; border-bottom:1px solid #ddd; padding:1rem; position:sticky; top:0; z-index:100;">
  <div style="max-width:400px; margin:0 auto; display:flex; justify-content:space-between; align-items:center;">
    <h1 style="margin:0; color:#333; font-size:24px; font-weight:600;">Matching</h1>
    <div style="display:flex; gap:0.5rem;">
      <!-- Sort Filter Button -->
      <button (click)="toggleFilterModal()"
        style="background:#6c5ce7; color:white; border:none; padding:0.5rem 1rem; border-radius:8px; cursor:pointer; font-size:12px; font-weight:500; transition:background 0.2s; display:flex; align-items:center; gap:0.3rem;"
        onmouseover="this.style.background='#5b4cdb'" onmouseout="this.style.background='#6c5ce7'">
        â‡… Sort
      </button>
      <!-- Search Filter Button -->
      <button (click)="toggleSearchModal()"
        style="background:#e74c3c; color:white; border:none; padding:0.5rem 1rem; border-radius:8px; cursor:pointer; font-size:12px; font-weight:500; transition:background 0.2s; display:flex; align-items:center; gap:0.3rem;"
        onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">
        ğŸ” Filter
      </button>
      </div>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="isLoading()" style="max-width:400px; margin:4rem auto; padding:2rem; border:1px solid #ddd; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.1); font-family:Arial, sans-serif; background:white; text-align:center;">
  <div style="color:#666; font-size:18px;">Loading profiles...</div>
</div>

<!-- No More Profiles -->
<div *ngIf="noMoreProfiles() && !isLoading()" style="max-width:400px; margin:4rem auto; padding:2rem; border:1px solid #ddd; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.1); font-family:Arial, sans-serif; background:white; text-align:center;">
  <div style="color:#666; font-size:18px; margin-bottom:1rem;">ğŸ˜”</div>
  <div style="color:#333; font-size:20px; font-weight:600; margin-bottom:0.5rem;">No more profiles to show</div>
  <div style="color:#666; font-size:16px;">Check back later for new matches!</div>
</div>

<!-- Profile Card -->
<div *ngIf="currentUser() && !isLoading() && !noMoreProfiles()"
  style="max-width:400px; margin:4rem auto; padding:0; border:1px solid #ddd; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.1); font-family:Arial, sans-serif; background:white; overflow:hidden; position:relative;">

  <!-- Likes You Badge -->
  <div *ngIf="currentUser()?.targetLikesMe"
    style="position:absolute; top:10px; right:10px; background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; padding:8px 16px; border-radius:20px; font-size:14px; font-weight:600; z-index:10; backdrop-filter:blur(5px); box-shadow:0 4px 12px rgba(240,147,251,0.4);">
    ğŸ’ Likes You!
  </div>
  
  <!-- Image Carousel -->
  <div style="position:relative; height:400px; overflow:hidden;">
    <!-- Main Image -->
    <img [src]="allImages()[currentImageIndex()]" 
         [alt]="currentUser()?.username + ' photo'"
         style="width:100%; height:100%; object-fit:cover;"
         onerror="this.src='https://via.placeholder.com/400x400?text=No+Image'">
    
    <!-- Navigation Arrows (only show if multiple images) -->
    <div *ngIf="allImages().length > 1">
      <!-- Left Arrow -->
      <button (click)="previousImage()" 
              style="position:absolute; left:10px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; transition:background 0.2s;"
              onmouseover="this.style.background='rgba(0,0,0,0.7)'"
              onmouseout="this.style.background='rgba(0,0,0,0.5)'">
        &#8249;
      </button>
      
      <!-- Right Arrow -->
      <button (click)="nextImage()" 
              style="position:absolute; right:10px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; transition:background 0.2s;"
              onmouseover="this.style.background='rgba(0,0,0,0.7)'"
              onmouseout="this.style.background='rgba(0,0,0,0.5)'">
        &#8250;
      </button>
      
      <!-- Image Indicators -->
      <div style="position:absolute; bottom:15px; left:50%; transform:translateX(-50%); display:flex; gap:6px;">
        <div *ngFor="let image of allImages(); let i = index"
             [style.background]="i === currentImageIndex() ? 'white' : 'rgba(255,255,255,0.5)'"
             style="width:8px; height:8px; border-radius:50%; transition:background 0.2s;">
        </div>
      </div>
    </div>
  </div>
  
  <!-- Profile Info -->
  <div style="padding:1.5rem;">
    <!-- Name and Age (Clickable) -->
    <h2 (click)="showUserDetailModal()"
      style="margin:0 0 0.5rem 0; color:#333; font-size:24px; font-weight:600; cursor:pointer; padding:0.5rem; border-radius:8px; transition:background-color 0.2s; display:inline-block;"
      onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
      {{ currentUser()?.username }}, {{ calculateAge(currentUser()?.dateOfBirth || '') }}
      <span style="font-size:16px; color:#666; margin-left:8px;">ğŸ‘¤</span>
    </h2>
    
    <!-- Page Info -->
    <p style="color:#666; margin:0 0 1.5rem 0; font-size:14px;">
      Profile {{ currentPage() + 1 }} of {{ totalPages() }}
    </p>
    
    <!-- Action Buttons -->
    <div style="display:flex; justify-content:space-around; gap:1rem;">
      <!-- Pass Button -->
      <button (click)="onPass()" 
              style="flex:1; background:#f44336; color:white; border:none; padding:0.75rem 1.5rem; border-radius:12px; cursor:pointer; font-size:16px; font-weight:600; transition:background 0.2s; box-shadow:0 2px 4px rgba(244,67,54,0.2);"
              onmouseover="this.style.background='#d32f2f'"
              onmouseout="this.style.background='#f44336'">
        âœ• Pass
      </button>
      
      <!-- Like Button -->
      <button (click)="onLike()" 
              style="flex:1; background:#4CAF50; color:white; border:none; padding:0.75rem 1.5rem; border-radius:12px; cursor:pointer; font-size:16px; font-weight:600; transition:background 0.2s; box-shadow:0 2px 4px rgba(76,175,80,0.2);"
              onmouseover="this.style.background='#388e3c'"
              onmouseout="this.style.background='#4CAF50'">
        â™¥ Like
      </button>
    </div>
  </div>
</div>

<!-- User Detail Modal -->
<app-user-detail-modal [show]="showUserDetail()" [mode]="'matching'" (close)="closeUserDetailModal()"
  (like)="onModalLike($event)" (pass)="onModalPass($event)"
  (userBlocked)="onUserBlocked($event)">
</app-user-detail-modal>
<!-- Filter Modal -->
<div *ngIf="showFilterModal()"
  style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;"
  (click)="closeFilterModal()">

  <div
    style="background:white; border-radius:16px; max-width:400px; width:100%; max-height:80vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.2);"
    (click)="$event.stopPropagation()">

    <!-- Modal Header -->
    <div
      style="padding:1.5rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0; color:#333; font-size:20px; font-weight:600;">Sort Settings</h3>
      <button (click)="closeFilterModal()"
        style="background:none; border:none; color:#666; font-size:24px; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:background 0.2s;"
        onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='none'">Ã—</button>
    </div>

    <!-- Filter Options -->
    <div style="padding:1.5rem;">

      <!-- Sort by Fame -->
      <div style="margin-bottom:1.5rem;">
        <h4 style="margin:0 0 1rem 0; color:#333; font-size:16px; font-weight:600;">ğŸ“Š Fame</h4>
        <div style="display:flex; gap:0.5rem;">
          <button (click)="applySortFilter('fame', 'desc')"
            [style.background]="sortBy() === 'fame' && order() === 'desc' ? '#6c5ce7' : '#f8f9fa'"
            [style.color]="sortBy() === 'fame' && order() === 'desc' ? 'white' : '#333'"
            style="flex:1; border:1px solid #ddd; padding:0.75rem; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s;">
            Highest
          </button>
          <button (click)="applySortFilter('fame', 'asc')"
            [style.background]="sortBy() === 'fame' && order() === 'asc' ? '#6c5ce7' : '#f8f9fa'"
            [style.color]="sortBy() === 'fame' && order() === 'asc' ? 'white' : '#333'"
            style="flex:1; border:1px solid #ddd; padding:0.75rem; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s;">
            Lowest
          </button>
        </div>
      </div>

      <!-- Sort by Age -->
      <div style="margin-bottom:1.5rem;">
        <h4 style="margin:0 0 1rem 0; color:#333; font-size:16px; font-weight:600;">ğŸ‚ Age</h4>
        <div style="display:flex; gap:0.5rem;">
          <button (click)="applySortFilter('age', 'asc')"
            [style.background]="sortBy() === 'age' && order() === 'asc' ? '#6c5ce7' : '#f8f9fa'"
            [style.color]="sortBy() === 'age' && order() === 'asc' ? 'white' : '#333'"
            style="flex:1; border:1px solid #ddd; padding:0.75rem; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s;">
            Youngest
          </button>
          <button (click)="applySortFilter('age', 'desc')"
            [style.background]="sortBy() === 'age' && order() === 'desc' ? '#6c5ce7' : '#f8f9fa'"
            [style.color]="sortBy() === 'age' && order() === 'desc' ? 'white' : '#333'"
            style="flex:1; border:1px solid #ddd; padding:0.75rem; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s;">
            Oldest
          </button>
        </div>
      </div>

      <!-- Sort by Distance -->
      <div style="margin-bottom:1.5rem;">
        <h4 style="margin:0 0 1rem 0; color:#333; font-size:16px; font-weight:600;">ğŸ“ Distance</h4>
        <div style="display:flex; gap:0.5rem;">
          <button (click)="applySortFilter('distance', 'asc')"
            [style.background]="sortBy() === 'distance' && order() === 'asc' ? '#6c5ce7' : '#f8f9fa'"
            [style.color]="sortBy() === 'distance' && order() === 'asc' ? 'white' : '#333'"
            style="flex:1; border:1px solid #ddd; padding:0.75rem; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s;">
            Nearest
          </button>
          <button (click)="applySortFilter('distance', 'desc')"
            [style.background]="sortBy() === 'distance' && order() === 'desc' ? '#6c5ce7' : '#f8f9fa'"
            [style.color]="sortBy() === 'distance' && order() === 'desc' ? 'white' : '#333'"
            style="flex:1; border:1px solid #ddd; padding:0.75rem; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s;">
            Farthest
          </button>
        </div>
      </div>

      <!-- Sort by Interest -->
      <div style="margin-bottom:1.5rem;">
        <h4 style="margin:0 0 1rem 0; color:#333; font-size:16px; font-weight:600;">ğŸ·ï¸ Interest Tags</h4>
        <div style="display:flex; gap:0.5rem;">
          <button (click)="applySortFilter('interest', 'desc')"
            [style.background]="sortBy() === 'interest' && order() === 'desc' ? '#6c5ce7' : '#f8f9fa'"
            [style.color]="sortBy() === 'interest' && order() === 'desc' ? 'white' : '#333'"
            style="flex:1; border:1px solid #ddd; padding:0.75rem; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s;">
            Most
          </button>
          <button (click)="applySortFilter('interest', 'asc')"
            [style.background]="sortBy() === 'interest' && order() === 'asc' ? '#6c5ce7' : '#f8f9fa'"
            [style.color]="sortBy() === 'interest' && order() === 'asc' ? 'white' : '#333'"
            style="flex:1; border:1px solid #ddd; padding:0.75rem; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s;">
            Least
          </button>
        </div>
      </div>

      <!-- Current Setting Info -->
      <div style="background:#f0f7ff; padding:1rem; border-radius:8px; border-left:4px solid #6c5ce7;">
        <div style="color:#333; font-size:14px; font-weight:500;">
          Current Setting: {{ getSortLabel() }}
        </div>
      </div>

    </div>
  </div>
</div>
<!-- Search Filter Modal -->
<div *ngIf="showSearchModal()"
  style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;"
  (click)="closeSearchModal()">

  <div
    style="background:white; border-radius:16px; max-width:500px; width:100%; max-height:90vh; overflow-y:auto; padding:20px;"
    (click)="$event.stopPropagation()">

    <h3 style="margin:0 0 20px 0; color:#333; text-align:center;">Search Filters</h3>

    <!-- Age Range -->
    <div style="margin-bottom:20px;">
      <h4 style="margin:0 0 10px 0; color:#333;">ğŸ‚ Age Range</h4>
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="display:flex; align-items:center; gap:5px; flex:1;">
          <span style="font-size:14px; color:#666;">Min:</span>
          <input type="number" [value]="ageRange().lower" (input)="updateAgeRange(+$any($event.target).value, ageRange().upper)"
            min="18" max="99" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
          </div>
        <div style="display:flex; align-items:center; gap:5px; flex:1;">
          <span style="font-size:14px; color:#666;">Max:</span>
          <input type="number" [value]="ageRange().upper" (input)="updateAgeRange(ageRange().lower, +$any($event.target).value)"
            min="18" max="99" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
          </div>
      </div>
    </div>

    <!-- Fame Range -->
    <div style="margin-bottom:20px;">
      <h4 style="margin:0 0 10px 0; color:#333;">ğŸ“Š Fame Range</h4>
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="display:flex; align-items:center; gap:5px; flex:1;">
          <span style="font-size:14px; color:#666;">Min:</span>
          <input type="number" [value]="fameRange().lower"
            (input)="updateFameRange(+$any($event.target).value, fameRange().upper)" min="0" max="15"
            style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
          </div>
        <div style="display:flex; align-items:center; gap:5px; flex:1;">
          <span style="font-size:14px; color:#666;">Max:</span>
          <input type="number" [value]="fameRange().upper"
            (input)="updateFameRange(fameRange().lower, +$any($event.target).value)" min="0" max="15"
            style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
          </div>
          </div>
    </div>

    <!-- Distance -->
    <div style="margin-bottom:20px;">
      <h4 style="margin:0 0 10px 0; color:#333;">ğŸ“ Max Distance</h4>
      <div style="position:relative; margin:20px 0;">
        <!-- Range Track -->
        <div style="height:8px; background:#ddd; border-radius:4px; position:relative;">
          <!-- Active Range (0 to current value) -->
          <div [style.width.%]="((maxDistance() - 1) / (10000 - 1)) * 100"
            style="position:absolute; height:100%; background:linear-gradient(to right, #3498db, #2980b9, #1abc9c); border-radius:4px;">
          </div>
        </div>
      
        <!-- Distance Range Input -->
        <input type="range" [value]="maxDistance()" (input)="maxDistance.set(+$any($event.target).value)" min="1" max="10000"
          step="100" class="distance-slider"
          style="position:absolute; top:-6px; width:100%; height:20px; background:transparent; pointer-events:auto; appearance:none; -webkit-appearance:none;">
      </div>
      
      <!-- Value Display -->
      <div style="display:flex; justify-content:center; align-items:center; margin-top:10px;">
        <span style="font-size:14px; color:#666; margin-right:10px;">Max Distance:</span>
        <input type="number" [value]="maxDistance()" (input)="maxDistance.set(+$any($event.target).value)" min="1" max="10000"
          step="100" style="width:80px; padding:4px; border:1px solid #ddd; border-radius:4px;">
        <span style="margin-left:5px; color:#666;">km</span>
      </div>
    </div>

    <!-- Interests -->
    <div style="margin-bottom:20px;">
      <h4 style="margin:0 0 10px 0; color:#333;">ğŸ·ï¸ Interests</h4>
      <div
        style="display:flex; flex-wrap:wrap; gap:8px; max-height:150px; overflow-y:auto; padding:10px; border:1px solid #ddd; border-radius:8px;">
        <span *ngFor="let interest of availableInterests()" (click)="toggleInterest(interest)"
          [style.background]="selectedInterests().includes(interest) ? '#e74c3c' : '#f8f9fa'"
          [style.color]="selectedInterests().includes(interest) ? 'white' : '#333'"
          style="padding:6px 12px; border-radius:16px; font-size:12px; cursor:pointer; border:1px solid #ddd; transition:all 0.2s; user-select:none;">
          {{ interest }}
        </span>
      </div>
      <div style="margin-top:5px; font-size:12px; color:#666;">
        Selected: {{ selectedInterests().length }} interests
      </div>
    </div>

    <!-- Action Buttons -->
    <div style="display:flex; gap:10px; margin-top:20px;">
      <button (click)="resetSearchFilter()"
        style="flex:1; padding:10px; background:#95a5a6; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px;">
        Reset
      </button>
      <button (click)="applySearchFilter()"
        style="flex:2; padding:10px; background:#e74c3c; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px;">
        Apply Filters
      </button>
    </div>

  </div>